---
title: 131108 Discuz 主从配置原理
layout: post
permalink: /2666.html
categories:
  - Code
tags:
  - discuz
  - 主从
  - 主从原理
  - 二次开发
---
之前有提到 discuz x3 开启 db主从后 报bug导致无法 正常使用 后来通过修改 // source/class/db/db\_driver\_mysql\_slave.php 参数设置为1 解决 。 原帖：131101 discuz x3 主从数据库配置 本周深入了解了下 原来是因为 二次开发的时候 某些不是很规范的写法引起的: db查询的时候没有使用 discuz 提供的 DB::table 导致。 修正完毕后 就可以正常使用了。 在这里转一篇关于 discuz 主从原理的文章 /source/class/class\_core.php 当配置了从库信息时，直接连接从库 discuz\_core::\_init\_db() function \_init\_db() { $class = 'db\_mysql'; if(count(getglobal('config/db/slave'))) { require\_once libfile('class/mysql\_slave'); $class = 'db\_mysql\_slave'; } $this->db = & DB::object($class); $this->db->set\_config($this->config['db']); $this->db->connect(); } db\_mysql::table\_name table\_name方法，每次将数据库连接curlink重置了主库连接。 其中$this->map为对数据库分库的配置，哪些表适用哪一个数据库，然后建立连接。 function table\_name($tablename) { if(!empty($this->map) && !empty($this->map[$tablename])) { $id = $this->map[$tablename]; if(!$this->link[$id]) { $this->connect($id); } $this->curlink = $this->link[$id]; } else { $this->curlink = $this->link[1]; } return $this->tablepre.$tablename; } DB::table 此方法调用db\_mysql::table\_name方法 function table($table) { return DB::\_execute('table\_name', $table); } /source/class/class\_mysql\_slave.php db\_mysql\_slave::table\_name slave的table方法，判断表是否在“slave\_except\_table”中，slave\_except\_table为配置的不使用从库连接的数据表 function table\_name($tablename) { if($this->slaveid && !$this->slaveexcept && $this->excepttables) { if(in\_array($tablename, $this->excepttables)) { $this->slaveexcept = true; } } db\_mysql\_slave::query slave的query方法，判段没有配置不使用从库的表，且sql语句为select时，才将curlink指向从库，否则curlink仍执行主库。 function query($sql, $type = '') { if($this->slaveid && !$this->slaveexcept && strtoupper(substr($sql, 0 , 6)) == 'SELECT') { $this->slave\_connect(); } $this->slaveexcept = false; return parent::query($sql, $type); } 总结： 1. 在扩展或做插件，使用数据库操作时，使用“DB::table($tablename)”来获取表名拼接sql就能兼容Discuz!X的主从库配置 2. 若仅使用主库连接，系统不会使用到db\_mysql_save的类 3. 每次页面请求，只有一个db对象。 使用connect和设置curlink来实现主从连接 转载自: http://discuzx.sinaapp.com/thread-12-1-1.html