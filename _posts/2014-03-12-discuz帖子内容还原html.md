---
title: 140312 discuz帖子内容还原HTML
layout: post
permalink: /2766.html
categories:
  - Code
tags:
  - discuz
  - parseattach
---
最近挖了个坑把自己埋得差不多了，唉，说点什么好呢？太lower么 新功能需要还原贴内信息，同步到其他系统。网上看了下并没有相关内容，并且有不少遇到了parseattach还原问题。这里发下我解决的代码： 关于贴内附件还原discuz原始方法： $tid=181281; $pid=4645197; $aid=190137; $pids = array ( $pid ); $attachs = array ( $pid => array ( $aid ) ); $list = array ( $pid => array ( 'message' => '嘀嗒嘀嗒嘀嗒嘀嗒嘀嗒嘀嗒的 的的的 的 <br />\[attach]190137\[/attach]<br />', 'pid' => $pid, 'attachments' => array () ) ); require\_once libfile ( 'function/attachment' ); $\_G ['tid'] = $tid; parseattach ( $pids, $attachs, $list ); var\_dump($list); 改良过得帖子内容还原 /*\* \*@param: 处理discuz帖子还原相关代码demo \*@desc : 2个函数去作为获取附件并且返回附件url参数最后替换attach \*/ $thread\_info = DB::fetch\_first ( "select a.\`tid\`, a.\`authorid\`, a.\`author\`,a.\`dateline\`, a.\`subject\`, b.\`message\` from " . DB::table ( 'forum\_thread' ) . " as a, " . DB::table ( 'forum\_post' ) . " as b where a.tid=$tid and a.tid=b.tid and b.first=1 order by pid desc limit 1" ); require\_once libfile ( 'function/discuzcode' ); $thread\_info ['dateline'] = date ( "Y-m-d H:i:s", $thread\_info ['dateline'] ); $thread\_info ['message'] = discuzcode ( $thread\_info ['message'] ); if (preg\_match\_all ( "/\[attach\\](\d+)\[\/attach\]/i", $thread\_info ['message'], $matchaids )) { $attach\_ids = $matchaids [1]; } $attach\_list = array (); foreach ( $attach\_ids as $aid ) { $find = "/\[attach\]$aid\[\/attach\]/i"; $thread\_info ['message'] = preg\_replace ( $find, get\_lw\_attach\_path ( $aid ), $thread\_info ['message'], 1 ); $thread\_info ['message'] = preg\_replace ( $find, '', $thread\_info ['message'] ); } function get\_lw\_attach\_path($aid) { global $\_G; $return = $filename = ''; if ($attach = C::t ( 'forum\_attachment\_n' )->fetch ( 'aid:' . $aid, $aid, array (1,- 1) )) { return get\_lw\_attach\_path\_str ( $attach ); } return $filename; } function get\_lw\_attach\_path\_str($attach) { global $\_G; if (! $attach ['isimage']) { return '<a href="' . $\_G ['siteurl'] . 'forum.php?mod=attachment&aid=' . aidencode ( $attach ['aid'] ) . '">' . $attach ['filename'] . '</a>'; } if ($attach ['remote']) { $imgurl = $\_G ['setting'\] \['ftp'\] ['attachurl'] . 'forum/' . $attach ['attachment']; return '<p><img onclick="viewimage(this);" src="' . $imgurl . '" /></p>'; } else { if (preg\_match ( '/^(?!http:)/', $attach ['url'] )) { $attach ['url'] = $\_G ['siteurl'] . 'data/attachment/forum/' . $attach ['url']; } $imgurl = $attach ['url'] . $attach ['attachment'] . ($\_G ['gp\_width'] ? '&width=' . $\_G ['gp\_width'] : '') . ($\_G ['gp\_height'] ? '&height=' . $\_G ['gp\_height'] : ''); return '<p><a href="' . $imgurl . '" target="_blank"><img height="320" width="320" src="' . $imgurl . '" /></a></p>'; } }