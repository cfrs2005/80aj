---
title: 130419 discuz x2.0 多数据库链接
layout: post
permalink: /2587.html
categories:
  - Code
tags:
  - discuz
  - PHP
  - 多数据库
  - 调用
  - 跨库操作
---
上次写过 discuz x2.5 现在写个2.0的 关于为什么要写 这个 实际上 dz 支持多数据库 只是相当得不友好 你可以通过 DB: 无限制的去操作下去 可是如果你的 跨数据库是影响 比如 帖子里的用户信息的时候 这就不足够的友好了 要来回切换数据库 不如新建1个实例 修改配置文件 config/config\_global.php $\_config\['db'\]\['5'\]\['dbhost'] = '192.168.1.2'; $\_config['db'\]\['5'\]\['dbuser'] = 'root'; $\_config['db'\]\['5'\]\['dbpw'] = '123'; $\_config['db'\]\['5'\]\['dbcharset'] = 'utf8'; $\_config['db'\]\['5'\]\['pconnect'] = '0'; $\_config['db'\]\['5'\]\['dbname'] = 'op'; $\_config['db'\]\['5'\]\['tablepre'] = 'op\_'; 修改文件 source/class/class\_core.php //在代码最下面增加2个新的函数 class db\_mysql\_bi { var $tablepre; var $version = ''; var $querynum = 0; var $slaveid = 0; var $curlink; var $link = array(); var $config = array(); var $sqldebug = array(); var $map = array(); function db\_mysql\_bi($config = array()) { if(!empty($config)) { $this->set\_config($config); } } function set\_config($config) { $this->config = &$config; $this->tablepre = $config['2'\]\['tablepre'\]; if(!empty($this->config\['map'])) { $this->map = $this->config['map']; } } function connect($serverid = 2) { if(empty($this->config) || empty($this->config[$serverid])) { $this->halt('config\_db\_not\_found'); } $this->link[$serverid] = $this->\_dbconnect( $this->config[$serverid\]\['dbhost'\], $this->config\[$serverid\]\['dbuser'\], $this->config\[$serverid\]\['dbpw'\], $this->config\[$serverid\]\['dbcharset'\], $this->config\[$serverid\]\['dbname'\], $this->config\[$serverid\]\['pconnect'\] ); $this->curlink = $this->link\[$serverid]; } function \_dbconnect($dbhost, $dbuser, $dbpw, $dbcharset, $dbname, $pconnect) { $link = null; $func = empty($pconnect) ? 'mysql\_connect' : 'mysql\_pconnect'; if(!$link = @$func($dbhost, $dbuser, $dbpw, 1)) { $this->halt('notconnect'); } else { $this->curlink = $link; if($this->version() > '4.1') { $dbcharset = $dbcharset ? $dbcharset : $this->config[1\]\['dbcharset'\]; $serverset = $dbcharset ? 'character\_set\_connection='.$dbcharset.', character\_set\_results='.$dbcharset.', character\_set\_client=binary' : ''; $serverset .= $this->version() > '5.0.1' ? ((empty($serverset) ? '' : ',').'sql\_mode=\'\'') : ''; $serverset && mysql\_query("SET $serverset", $link); } $dbname && @mysql\_select\_db($dbname, $link); } return $link; } function table\_name($tablename) { if(!empty($this->map) && !empty($this->map\[$tablename])) { $id = $this->map[$tablename]; if(!$this->link[$id]) { $this->connect($id); } $this->curlink = $this->link[$id]; } else { $this->curlink = $this->link[1]; } return $this->tablepre.$tablename; } function select\_db($dbname) { return mysql\_select\_db($dbname, $this->curlink); } function fetch\_array($query, $result\_type = MYSQL\_ASSOC) { return mysql\_fetch\_array($query, $result\_type); } function fetch\_first($sql) { return $this->fetch\_array($this->query($sql)); } function result\_first($sql) { return $this->result($this->query($sql), 0); } function query($sql, $type = '') { if(defined('DISCUZ\_DEBUG') && DISCUZ\_DEBUG) { $starttime = dmicrotime(); } $func = $type == 'UNBUFFERED' && @function\_exists('mysql\_unbuffered\_query') ? 'mysql\_unbuffered\_query' : 'mysql\_query'; if(!($query = $func($sql, $this->curlink))) { if(in\_array($this->errno(), array(2006, 2013)) && substr($type, 0, 5) != 'RETRY') { $this->connect(); return $this->query($sql, 'RETRY'.$type); } if($type != 'SILENT' && substr($type, 5) != 'SILENT') { $this->halt('query\_error', $sql); } } if(defined('DISCUZ\_DEBUG') && DISCUZ\_DEBUG) { $this->sqldebug[] = array($sql, number\_format((dmicrotime() - $starttime), 6), debug\_backtrace()); } $this->querynum++; return $query; } function affected\_rows() { return mysql\_affected\_rows($this->curlink); } function error() { return (($this->curlink) ? mysql\_error($this->curlink) : mysql\_error()); } function errno() { return intval(($this->curlink) ? mysql\_errno($this->curlink) : mysql\_errno()); } function result($query, $row = 0) { $query = @mysql\_result($query, $row); return $query; } function num\_rows($query) { $query = mysql\_num\_rows($query); return $query; } function num\_fields($query) { return mysql\_num\_fields($query); } function free\_result($query) { return mysql\_free\_result($query); } function insert\_id() { return ($id = mysql\_insert\_id($this->curlink)) >= 0 ? $id : $this->result($this->query("SELECT last\_insert\_id()"), 0); } function fetch\_row($query) { $query = mysql\_fetch\_row($query); return $query; } function fetch\_fields($query) { return mysql\_fetch\_field($query); } function version() { if(empty($this->version)) { $this->version = mysql\_get\_server\_info($this->curlink); } return $this->version; } function close() { return mysql\_close($this->curlink); } function halt($message = '', $sql = '') { require\_once libfile('class/error'); discuz\_error::db\_error($message, $sql); } } class DB\_BI { function table($table) { return DB\_BI::\_execute('table\_name', $table); } function delete($table, $condition, $limit = 0, $unbuffered = true) { if(empty($condition)) { $where = '1'; } elseif(is\_array($condition)) { $where = DB\_BI::implode\_field\_value($condition, ' AND '); } else { $where = $condition; } $sql = "DELETE FROM ".DB\_BI::table($table)." WHERE $where ".($limit ? "LIMIT $limit" : ''); return DB\_BI::query($sql, ($unbuffered ? 'UNBUFFERED' : '')); } function insert($table, $data, $return\_insert\_id = false, $replace = false, $silent = false) { $sql = DB\_BI::implode\_field\_value($data); $cmd = $replace ? 'REPLACE INTO' : 'INSERT INTO'; $table = DB\_BI::table($table); $silent = $silent ? 'SILENT' : ''; $return = DB\_BI::query("$cmd $table SET $sql", $silent); return $return\_insert\_id ? DB\_BI::insert\_id() : $return; } function update($table, $data, $condition, $unbuffered = false, $low\_priority = false) { $sql = DB\_BI::implode\_field\_value($data); $cmd = "UPDATE ".($low\_priority ? 'LOW\_PRIORITY' : ''); $table = DB\_BI::table($table); $where = ''; if(empty($condition)) { $where = '1'; } elseif(is\_array($condition)) { $where = DB\_BI::implode\_field\_value($condition, ' AND '); } else { $where = $condition; } $res = DB\_BI::query("$cmd $table SET $sql WHERE $where", $unbuffered ? 'UNBUFFERED' : ''); return $res; } function implode\_field\_value($array, $glue = ',') { $sql = $comma = ''; foreach ($array as $k => $v) { $sql .= $comma."\`$k\`='$v'"; $comma = $glue; } return $sql; } function insert\_id() { return DB\_BI::\_execute('insert\_id'); } function fetch($resourceid, $type = MYSQL\_ASSOC) { return DB\_BI::\_execute('fetch\_array', $resourceid, $type); } function fetch\_first($sql) { DB\_BI::checkquery($sql); return DB\_BI::\_execute('fetch\_first', $sql); } function result($resourceid, $row = 0) { return DB\_BI::\_execute('result', $resourceid, $row); } function result\_first($sql) { DB\_BI::checkquery($sql); return DB\_BI::\_execute('result\_first', $sql); } function query($sql, $type = '') { DB\_BI::checkquery($sql); return DB\_BI::\_execute('query', $sql, $type); } function num\_rows($resourceid) { return DB\_BI::\_execute('num\_rows', $resourceid); } function affected\_rows() { return DB\_BI::\_execute('affected\_rows'); } function free\_result($query) { return DB\_BI::\_execute('free\_result', $query); } function error() { return DB\_BI::\_execute('error'); } function errno() { return DB\_BI::\_execute('errno'); } function \_execute($cmd , $arg1 = '', $arg2 = '') { static $db\_bi; if(empty($db\_bi)) $db\_bi = & DB\_BI::object(); $res = $db\_bi->$cmd($arg1, $arg2); return $res; } function &object($db\_biclass = 'db\_mysql\_bi') { static $db\_bi; if(empty($db\_bi)) $db\_bi = new $db\_biclass(); return $db\_bi; } function checkquery($sql) { static $status = null, $checkcmd = array('SEL'=>1, 'UPD'=>1, 'INS'=>1, 'REP'=>1, 'DEL'=>1); if($status === null) $status = getglobal('config/security/querysafe/status'); if($status) { $test = 1; $cmd = strtoupper(substr(trim($sql), 0, 3)); if(isset($checkcmd[$cmd])) { $test = DB\_BI::\_do\_query\_safe($sql); } elseif(substr($cmd, 0, 2) === '/\*') { $test = -1; } if($test < 1) DB\_BI::\_execute('halt', 'security\_error', $sql); } return true; } function \_do\_query\_safe($sql) { static $\_CONFIG = null; if($\_CONFIG === null) { $\_CONFIG = getglobal('config/security/querysafe'); } $sql = str\_replace(array('\\\\', '\\\'', '\\"', '\'\''), '', $sql); $mark = $clean = ''; if(strpos($sql, '/') === false && strpos($sql, '#') === false && strpos($sql, '-- ') === false) { $clean = preg\_replace("/'(.+?)'/s", '', $sql); } else { $len = strlen($sql); $mark = $clean = ''; for ($i = 0; $i <$len; $i++) { $str = $sql[$i]; switch ($str) { case '\'': if(!$mark) { $mark = '\''; $clean .= $str; } elseif ($mark == '\'') { $mark = ''; } break; case '/': if(empty($mark) && $sql[$i+1] == '\*') { $mark = '/\*'; $clean .= $mark; $i++; } elseif($mark == '/\*' && $sql[$i -1] == '\*') { $mark = ''; $clean .= '\*'; } break; case '#': if(empty($mark)) { $mark = $str; $clean .= $str; } break; case "\n": if($mark == '#' || $mark == '--') { $mark = ''; } break; case '-': if(empty($mark)&& substr($sql, $i, 3) == '-- ') { $mark = '-- '; $clean .= $mark; } break; default: break; } $clean .= $mark ? '' : $str; } } $clean = preg\_replace("/[^a-z0-9\_\-\(\)#\*\/\"]+/is", "", strtolower($clean)); if($\_CONFIG['afullnote']) { $clean = str\_replace('/*\*/','',$clean); } if(is\_array($\_CONFIG['dfunction'])) { foreach($\_CONFIG['dfunction'] as $fun) { if(strpos($clean, $fun.'(') !== false) return '-1'; } } if(is\_array($\_CONFIG['daction'])) { foreach($\_CONFIG['daction'] as $action) { if(strpos($clean,$action) !== false) return '-3'; } } if($\_CONFIG['dlikehex'] && strpos($clean, 'like0x')) { return '-2'; } if(is\_array($\_CONFIG['dnote'])) { foreach($\_CONFIG['dnote'] as $note) { if(strpos($clean,$note) !== false) return '-4'; } } return 1; } 实例 Discuz x2.0 多数据库调用 $db\_bi= & DB\_BI::object(); $db\_bi->set\_config($\_G['config'\]\['db'\]); $db\_bi->connect(); $userinfo = DB\_BI::fetch\_first("SELECT \* from aj\_db limit 10"); var\_dump($userinfo); 最后福利 关于 2.0 文本CACHE用法 require\_once libfile('function/cache'); writetocache('ceshi', getcachevars(array('userinfo' => $userinfo))); unset($userinfo); if(file\_exists($testfile = DISCUZ\_ROOT.'./data/cache/cache\_ceshi.php')) { @include $testfile; } var_dump($userinfo);