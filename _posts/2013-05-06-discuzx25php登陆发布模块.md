---
title: 130506 Discuz X2.5 PHP 登陆发布模块
layout: post
permalink: /2596.html
categories:
  - Code
tags:
  - discuz
  - PHP
  - x2.5
  - 发布
  - 登陆
---
Class 类 class\_dz.php /\* \* @author 80aj \* @email a@80aj.com \* @descripton: 原作者:大水车,实现discuz2.5登陆发帖 \* @filename class\_dz.php \*/ class discuz\_post { const LOGIN\_PROGRAM = 'member.php?mod=logging&action=login&loginsubmit=yes&infloat=yes'; const POST\_PROGRAM = 'forum.php?mod=post&action=newthread&fid='; private $host; private $cookie\_file; /*\* \* \* @param unknown $host \*/ public function _\_construct($host) { $this->host = $host; } /*\* \* \* @return unknown \*/ public function get\_formhash() { $login\_url = $this->\_get\_Login\_Url (); $ch = curl\_init (); curl\_setopt ( $ch, CURLOPT\_URL, $login\_url ); curl\_setopt ( $ch, CURLOPT\_HEADER, false ); curl\_setopt ( $ch, CURLOPT\_RETURNTRANSFER, true ); $contents = curl\_exec ( $ch ); curl\_close ( $ch ); preg\_match ( '/<input type="hidden" name="formhash" value="(.\*)" \/>/isU', $contents, $matches ); if (! empty ( $matches )) { $formhash = $matches \[1]; } else { // die('Not found the forumhash.'); } return $formhash; } /\*\* \* \* @param unknown $post \* @return string \*/ public function login($user, $pass) { $login\_info = array ( 'username' => $user, 'password' => $pass, 'referer' => $this->host, 'questionid' => 0, 'answer' => '', 'seccodeverify' => '', 'formhash' => $this->get\_formhash () ); $login\_url = $this->\_get\_Login\_Url (); $cookie\_file = tempnam ( './temp', 'cookie' ); $ch = curl\_init ( $login\_url ); curl\_setopt ( $ch, CURLOPT\_HEADER, false ); curl\_setopt ( $ch, CURLOPT\_RETURNTRANSFER, true ); curl\_setopt ( $ch, CURLOPT\_POST, true ); curl\_setopt ( $ch, CURLOPT\_POSTFIELDS, $login\_info ); curl\_setopt ( $ch, CURLOPT\_COOKIEJAR, $cookie\_file ); curl\_exec ( $ch ); curl\_close ( $ch ); $this->cookie\_file = $cookie\_file; return $cookie\_file; } /\*\* \* \* @param unknown $fid \* @return string \*/ public function use\_cookie($fid) { $send\_url = $this->\_get\_Post\_Url ( $fid ); $ch = curl\_init (); curl\_setopt ( $ch, CURLOPT\_URL, $send\_url ); curl\_setopt ( $ch, CURLOPT\_HEADER, false ); curl\_setopt ( $ch, CURLOPT\_RETURNTRANSFER, true ); curl\_setopt ( $ch, CURLOPT\_COOKIEFILE, $this->cookie\_file ); $contents = curl\_exec ( $ch ); curl\_close ( $ch ); preg\_match\_all ( '/<input type="hidden" name="formhash" id="formhash" value="(.\*)" \/>/isU', $contents, $matches ); if (! empty ( $matches )) { $formhash = $matches [1\] \[0\]; } else { $formhash = ''; } return $formhash; } /*\* \* \* @param unknown $fid \* @param unknown $thread\_data \*/ public function post\_newthread($fid, $title, $content, $tags) { $thread\_data = array ( 'subject' => $title, 'message' => $content, 'topicsubmit' => "yes", 'extra' => '', 'tags' => $tags, 'formhash' => $this->use\_cookie ( $fid ) ); $send\_url = $this->\_get\_Post\_Url ( $fid ); $ch = curl\_init (); curl\_setopt ( $ch, CURLOPT\_URL, $send\_url ); curl\_setopt ( $ch, CURLOPT\_REFERER, $send\_url ); curl\_setopt ( $ch, CURLOPT\_HEADER, false ); curl\_setopt ( $ch, CURLOPT\_RETURNTRANSFER, true ); curl\_setopt ( $ch, CURLOPT\_COOKIEFILE, $this->cookie\_file ); curl\_setopt ( $ch, CURLOPT\_POST, true ); curl\_setopt ( $ch, CURLOPT\_POSTFIELDS, $thread\_data ); $contents = curl\_exec ( $ch ); curl\_close ( $ch ); return; } /\*\* \* \* @param unknown $fid \* @return string \*/ private function \_get\_Post\_Url($fid) { return $this->host . self::POST\_PROGRAM . intval ( $fid ); } /\*\* \* \* @return string \*/ private function \_get\_Login\_Url() { return $this->host . self::LOGIN\_PROGRAM; } } 测试实现类 include\_once 'class\_dz.php'; $host = "http://localhost/dz/"; // 服务器地址 $fid = 2; // 板块ID $user = "admin"; // 用户名 $pass = "admin"; // 用户密码 $title = "美女大家一起来看"; // 标题 $content = "必须是美女才发,你说是不"; // 正文 $tags = "美女万岁,oh yeah"; // tags $rc = new discuz\_post ( $host ); $rc->login ( $user, $pass ); $rc->post\_newthread ( $fid, $title, $content, $tags );