---
title: 120930 gxcms(1.4)关于采集图片失效的问题解决
layout: post
permalink: /2334.html
categories:
  - Code
tags:
  - gxcms
  - 图片失效
  - 图片采集
---
 刚开始使用gxcms得时候 由于VPS服务器的硬盘有点小 没有远程存储图片，但随着时间的迁移，很多图片都在不断得失效,所以开启了图片本地化功能. 当开启功能后 发下很多图片远程地址已经不存在，虽然gxcms 提供了 重新采集资料 。但如果你重新采集资料 那么你已经下载的图片会重新下载，对于拥有2W资源+的站来说 一次下载过程是极度得损耗的 ，所以我一直没有这么去做。 今天无聊闲着蛋疼我改了下 代码修改很简单 见已经修正的源码. 修改1个文件即可 /core/lib/model/XmlzyModel.class.php VdoDB=D('video'); } /*\* \* 通过远程地址参数抓取需要的数据 \* GetParams \*/ public function xml\_httpurl(){ $array\_url = array(); //本地程序跳转参数与远程变量参数 $array\_tpl = array(); //本地程序模板变量参数 //获取跳转参数 $array\_url\['ziyuan'] = !empty($\_GET['ziyuan'])?trim($\_GET['ziyuan']):'gxcms'; //合作资源站程序 $array\_url['fid'] = $\_GET['fid']; //合作渠道ID $array\_url['action'] = $\_GET['action']; //是否入库(all/day/ids) $array\_url['xmlurl'] = $\_GET['xmlurl']; //资源库网址 $array\_url['reurl'] = $\_GET['reurl']; //来源网址 $array\_url['pic'] = $\_GET['pic']; //重采图片 // $array\_url['cid'] = $\_GET['cid']; //指定视频分类 $array\_url['wd'] = $\_GET['wd']; if($\_POST['wd']){//指定关键字 $array\_url['wd'] = trim($\_POST['wd']); } $array\_url['h'] = intval($\_GET['h']); //指定时间 $array\_url['p'] = !empty($\_GET['p'])?intval($\_GET['p']):1; $array\_url['page'] = $array\_url['p']; //指定分页 $array\_url['vodids'] = $\_GET['vodids']; //指定视频ID if($\_POST['ids'] &#038;&#038; ($array\_url['action']=='ids')){//手工选择要采集影片 $array\_url['vodids'] = implode(',',$\_POST['ids']); } $array\_url['inputer'] = $\_GET['inputer']; //指定资源库频道 $array\_url['play'] = $\_GET['play']; //指定播放器组(如不指定则为目标站的全部播放器组) // 分支资源库程序 $zymodel = 'ziyuan\_'.$array\_url['ziyuan']; return $this->$zymodel($array\_url); } /*\* \* 资源站为A类型 \* @param array $array\_url \* @return array \*/ public function ziyuan\_a($array\_url){ //组合资源库A类型的URL地址并获取XML资源 $array\_tpl['httpurl'] = '&#038;wd='.urlencode($array\_url['wd']).'&#038;t='.$array\_url['cid'].'&#038;h='.$array\_url['h'].'&#038;ids='.$array\_url['vodids'].'&#038;pg='.$array\_url['p']; if($array\_url['action']){ $array\_tpl['httpurl'] = str\_replace('?ac=list','?ac=videolist',$array\_url['xmlurl']).$array\_tpl['httpurl']; }else{ $array\_tpl['httpurl'] = $array\_url['xmlurl'].$array\_tpl['httpurl']; } $array\_tpl['httpurl'] = str\_replace('@','/',$array\_tpl['httpurl']);//还原目标网址 //抓取地址开始 $xml = get\_collect\_file($array\_tpl['httpurl']); if ($xml) { //组合分页信息 preg\_match('',$xml,$page\_array); $xml\_page['recordcount'] = $page\_array[4]; $xml\_page['pagecount'] = $page\_array[2]; $xml\_page['pagesize'] = $page\_array[3]; $xml\_page['pageindex'] = $page\_array[1]; $array\_url['p'] = '{!page!}'; $array\_tpl['pageurl'] = U('Admin-Collect/Gxcms',$array\_url); $array\_tpl['pagelist'] = '共'.$xml\_page['recordcount'].'条数据&nbsp;页次:'.$xml\_page['pageindex'].'/'.$xml\_page['pagecount'].'页&nbsp;'.get\_cms\_page\_css($xml\_page['pageindex'],$xml\_page['pagecount'],5,$array\_tpl['pageurl'],'pagego(\''.$array\_tpl['pageurl'].'\','.$xml\_page['pagecount'].')'); //组合绑定分类 preg\_match\_all('/([\s\S]\*?)/',$xml,$array\_list); foreach($array\_list[1] as $key=>$value){ $list[$key\]\['cid'\] = $value; $list\[$key\]\['cname'\] = $array\_list\[2\]\[$key\]; $list\[$key\]\['bind\_id'\]= $array\_url\['fid'].'\_'.$value; } if($array\_url['action']){ preg\_match\_all('/([\s\S]\*?)([0-9]+)([0-9]+)([\s\S]\*?)([\s\S]\*?)([\s\S]\*?)([\s\S]\*?)([\s\S]\*?)([\s\S]\*?)([\s\S]\*?)/',$xml,$array\_vod); }else{ preg\_match\_all('/([\s\S]\*?)([0-9]+)([0-9]+)([\s\S]\*?)([\s\S]\*?)/',$xml,$array\_vod); } //组合数据 foreach($array\_vod[1] as $key=>$value){ $vod[$key\]\['addtime'\] = $value; $vod\[$key\]\['id'\] = $array\_vod\[2\]\[$key\]; $vod\[$key\]\['iid'\] = $array\_vod\[2\]\[$key\]; $vod\[$key\]\['cid'\] = getbindval($array\_url\['fid'].'\_'.$array\_vod[3\]\[$key\]); $vod\[$key\]\['title'\] = htmlspecialchars\_decode($array\_vod\[4\]\[$key\]); $vod\[$key\]\['cname'\] = $array\_vod\[5\]\[$key\]; $vod\[$key\]\['picurl'\] = $array\_vod\[6\]\[$key\]; $vod\[$key\]\['language'\] = $array\_vod\[7\]\[$key\]; $vod\[$key\]\['area'\] = $array\_vod\[8\]\[$key\]; $vod\[$key\]\['year'\] = $array\_vod\[9\]\[$key\]; $vod\[$key\]\['serial'\] = $array\_vod\[10\]\[$key\]; $vod\[$key\]\['intro'\] = htmlspecialchars\_decode($array\_vod\[11\]\[$key\]); if($array\_url\['action']){ $vod[$key\]\['actor'\]= htmlspecialchars\_decode($array\_vod\[12\]\[$key\]); }else{ $vod\[$key\]\['actor'\]= htmlspecialchars\_decode($array\_vod\[8\]\[$key\]); } $vod\[$key\]\['director'\] = htmlspecialchars\_decode($array\_vod\[13\]\[$key\]); $vod\[$key\]\['content'\] = htmlspecialchars\_decode($array\_vod\[15\]\[$key\]); $vod\[$key\]\['inputer'\] = $array\_url\['fid'].'\_'.$vod[$key\]\['id'\]; $vod\[$key\]\['reurl'\] = str\_replace('@','/',$array\_url\['reurl']).$vod[$key\]\['id'\]; preg\_match\_all('//',$array\_vod\[14\]\[$key\],$url\_arr); $vod\[$key\]\['playurl'\] = htmlspecialchars\_decode($this->xml\_url\_replace(implode('$$$',$url\_arr\[2]))); } $array['url'] = $array\_url; //远程URL变量 $array['tpl'] = $array\_tpl; //本地模板变量 $array['page'] = $xml\_page; //远程分页信息 $array['listclass'] = $list; //远程分类变量 $array['listvod'] = $vod; //远程数据变量 return $array; }else{ return false; } } /\*\* \* 资源站为gxcms系统 \* \* @param array $array\_url \* @return \*/ public function ziyuan\_gx($array\_url){ //组合资源库URL地址并获取XML资源 $array\_tpl['httpurl'] = $array\_url['xmlurl'].'/index.php?s=plus/xml/show/vodids/'.$array\_url['vodids'].'/cid/'.$array\_url['cid'].'/wd/'.urlencode($array\_url['wd']).'/h/'.$array\_url['h'].'/p/'.$array\_url['p']; //还原资源站网址 $array\_tpl['httpurl'] = str\_replace('@','/',$array\_tpl['httpurl']); $xml = get\_collect\_file($array\_tpl['httpurl']); if ($xml) { return $this->ff\_gx\_xml($array\_url,$xml); }else{ return false; } } /*\* \* 资源站为飞飞影视系统 \* \* @param array $array\_url \* @return \*/ public function ziyuan\_feifei($array\_url){ $array\_tpl['httpurl'] = $array\_url['xmlurl'].'/index.php?s=plus-api-xml-cms-ff-action-'.$array\_url['action'].'-vodids-'.$array\_url['vodids'].'-cid-'.$array\_url['cid'].'-wd-'.urlencode($array\_url['wd']).'-h-'.$array\_url['h'].'-p-'.$array\_url['p']; $array\_tpl['httpurl'] = str\_replace('@','/',$array\_tpl['httpurl']);//还原目标网址 $xml = get\_collect\_file($array\_tpl['httpurl']); if ($xml) { return $this->ff\_gx\_xml($array\_url,$xml); }else{ return false; } } /*\* \* 将资源站抓取的值整理成数组变量(飞飞+光线) \* \* @param $array\_url \* @param $xml \*/ public function ff\_gx\_xml($array\_url,$xml){ //组合分页信息 preg\_match('',$xml,$page\_array); $xml\_page['recordcount'] = $page\_array[4]; $xml\_page['pagecount'] = $page\_array[2]; $xml\_page['pagesize'] = $page\_array[3]; $xml\_page['pageindex'] = $page\_array[1]; $array\_url['p'] = '{!page!}'; $array\_tpl['pageurl'] = U('Admin-Collect/Gxcms',$array\_url); $array\_tpl['pagelist'] = '共'.$xml\_page['recordcount'].'条数据&nbsp;页次:'.$xml\_page['pageindex'].'/'.$xml\_page['pagecount'].'页&nbsp;'.get\_cms\_page\_css($xml\_page['pageindex'],$xml\_page['pagecount'],5,$array\_tpl['pageurl'],'pagego(\''.$array\_tpl['pageurl'].'\','.$xml\_page['pagecount'].')'); //组合绑定分类 preg\_match\_all('/([\s\S]\*?)/',$xml,$array\_list); foreach($array\_list[1] as $key=>$value){ $list[$key\]\['cid'\] = $value; $list\[$key\]\['cname'\] = $array\_list\[2\]\[$key\]; $list\[$key\]\['bind\_id'\] = $array\_url\['fid'].'\_'.$value; } //组合单个影视数据 preg\_match\_all('/([\s\S]\*?)([0-9]+)([0-9]+)([\s\S]\*?)([\s\S]\*?)([\s\S]\*?)([\s\S]\*?)([\s\S]\*?)([\s\S]\*?)([\s\S]\*?)([\s\S]\*?)([\s\S]\*?)/',$xml,$array\_vod); foreach($array\_vod[1] as $key=>$value){ $vod[$key\]\['addtime'\] = $value; $vod\[$key\]\['id'\] = $array\_vod\[2\]\[$key\]; $vod\[$key\]\['iid'\] = $array\_vod\[2\]\[$key\]; $vod\[$key\]\['cid'\] = getbindval($array\_url\['fid'].'\_'.$array\_vod[3\]\[$key\]); $vod\[$key\]\['title'\] = htmlspecialchars\_decode($array\_vod\[4\]\[$key\]); $vod\[$key\]\['cname'\] = $array\_vod\[5\]\[$key\]; $vod\[$key\]\['picurl'\] = $array\_vod\[7\]\[$key\]; $vod\[$key\]\['language'\] = $array\_vod\[8\]\[$key\]; $vod\[$key\]\['area'\] = $array\_vod\[9\]\[$key\]; $vod\[$key\]\['year'\] = $array\_vod\[10\]\[$key\]; $vod\[$key\]\['serial'\] = $array\_vod\[11\]\[$key\]; $vod\[$key\]\['intro'\] = htmlspecialchars\_decode($array\_vod\[12\]\[$key\]); $vod\[$key\]\['actor'\] = htmlspecialchars\_decode($array\_vod\[13\]\[$key\]); $vod\[$key\]\['director'\] = htmlspecialchars\_decode($array\_vod\[14\]\[$key\]); $vod\[$key\]\['content'\] = htmlspecialchars\_decode($array\_vod\[16\]\[$key\]); $vod\[$key\]\['inputer'\] = $array\_url\['fid'].'\_'.$vod[$key\]\['id'\]; $vod\[$key\]\['reurl'\] = $array\_vod\[17\]\[$key\]; if(!$vod\[$key\]\['reurl'\]){ $vod\[$key\]\['reurl'\]= str\_replace('@','/',$array\_url\['reurl']).$vod[$key\]\['id'\]; } preg\_match\_all('//',$array\_vod\[15\]\[$key\],$url\_arr); $vod\[$key\]\['playurl'\] = htmlspecialchars\_decode(implode('$$$',$url\_arr[2])); } $array['url'] = $array\_url; //远程URL变量 $array['tpl'] = $array\_tpl; //本地模板变量 $array['page'] = $xml\_page; //远程分页信息 $array['listclass'] = $list; //远程分类变量 $array['listvod'] = $vod; //远程数据变量 return $array; } /\*\* \* XML方式获取到的资源站地址转化为gxcms的地址 \* \* @param string $playurl \* @return string $gxurl \*/ public function xml\_url\_replace($playurl){ $array\_url = array(); $arr\_ji = explode('#',$playurl); foreach($arr\_ji as $key=>$value){ $urlji = explode('$',$value); if(count($urlji)==3){ $array\_url[$key] = $urlji[0].'$'.$urlji[1]; }else{ $array\_url[$key] = $urlji[0]; } } return implode(chr(13),$array\_url); } /*\* \* 采集影片入库 \* @param array $vod 新采集数据 \* @param boolean $must 是否强制更新 \*/ public function xml\_insert($vod,$must){ if(empty($vod['title']) || empty($vod['playurl'])){ return '影片名称或播放地址为空，不做处理!'; } //未入库标识 if ( !$vod['cid'] ) { //$vod['cid'] = 999; return '未匹配到对应栏目分类，不做处理!'; } //过滤常规重复字符 $vod['title'] = str\_replace(array('HD','BD','DVD','VCD','TS','【完结】','【】','[]','()'),'',$vod['title']); $vod['actor'] = str\_replace(array(',','/','，','|','、'),' ',$vod['actor']); $vod['director'] = str\_replace(array(',','/','，','|','、'),' ',$vod['director']); //入库开始 unset($vod['id']); $array = $this->VdoDB->field('id,cid,title,inputer,playurl,pic,picurl')->where('reurl="'.$vod['reurl'].'"')->find(); if($array){ //有来源.检测影片地址是否发生变化 return $this->xml\_update($vod,$array,$must); }else{ //无来源.检测是否有相同影片(需防止同名的电影与电视冲突) $array = $this->VdoDB->field('id,cid,title,intro,actor,inputer,playurl,picurl')->where('title="'.$vod['title'].'"')->find(); if($array){ //无主演时直接更新该影片 if(empty($vod['actor'])){ return $this->xml\_update($vod,$array,$must); } //演员完全相等时更新该影片 if($array['actor'] == $vod['actor']){ return $this->xml\_update($vod,$array,$must); } //有相同演员时更新该影片 $arr\_actor\_1 = explode(' ',$vod['actor']); $arr\_actor\_2 = explode(' ',str\_replace(array(',','/','，','|','、'),' ',$array['actor'])); if(array\_intersect($arr\_actor\_1,$arr\_actor\_2)){ return $this->xml\_update($vod,$array,$must); } } //其它条件将新加影片，添加前做相似条件判断 if(C('web\_collect\_num')){ $length = ceil(strlen($vod['title'])/3)-intval(C('web\_collect\_num')); if($length >= 2){ $where['title'] = array('like','%'.get\_replace\_html($vod['title'],0,$length).'%'); $array = $this->VdoDB->field('id,title,inputer,actor,playurl')->where($where)->find(); //主演完全相同则更新 if(!empty($array['actor']) &#038;&#038; !empty($vod['actor']) ){ //对比 $arr\_actor\_1 = explode(' ',$vod['actor']); $arr\_actor\_2 = explode(' ',str\_replace(array(',','/','，','|','、'),' ',$array['actor'])); if(!array\_diff($arr\_actor\_1,$arr\_actor\_2) &#038;&#038; !array\_diff($arr\_actor\_2,$arr\_actor\_1)){//若差集为空 return $this->xml\_update($vod,$array,$must); } //主演不完全相同则添加 } if(!in\_array($vod['inputer'],$array) &#038;&#038; $array){//inputer不同则隐藏 $vod['status'] = -1; } } } //添加影片开始 if (C('upload\_http')) { $down = D('Down'); $vod['picurl'] = $down->down\_img($vod['picurl']); } $this->VdoDB->data($vod)->add(); return '视频添加成功！'; } } /\*\* \* 影片更新检测 \* \* @param array $vod 新采集数据 \* @param array $array 数据库查询获取数据 \* @param boolean $must */ public function xml\_update($vod,$array,$must=false){ if('gxcms' == $array['inputer']){ return '站长手动锁定，退出更新！'; } if(!$must){//是否强制更新资料 if ($array['playurl'] == $vod['playurl']) { return '播放地址未变化，退出更新！'; } $count\_vod = count(explode(chr(13),($vod['playurl']))); $count\_array = count(explode(chr(13),trim($array['playurl']))); if($count\_vod < $count\_array){ return '小于数据库集数，退出更新！'; } }else{ if (C('upload\_http')) { $down = D('Down'); $edit['picurl'] = $down->down\_img($vod['picurl']); }else{ if (preg\_match("/222.187.221.168/", $array['picurl'])) { $edit['picurl'] = $vod['picurl']; } } $edit['title'] = $vod['title']; $edit['actor'] = $vod['actor']; $edit['director'] = $vod['director']; $edit['area'] = $vod['area']; $edit['language'] = $vod['language']; $edit['reurl'] = $vod['reurl']; } $edit['intro'] = $vod['intro']; $edit['cid'] = $vod['cid']; $edit['serial'] = $vod['serial']; $edit['playurl'] = $vod['playurl']; $edit['addtime'] = time(); $edit['reurl'] = $vod['reurl']; $this->VdoDB->where('id='.$array['id'])->data($edit)->save(); return '播放地址更新成功！'; } } ?>